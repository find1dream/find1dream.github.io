<!DOCTYPE html> <html> <head> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>Bellman Equation V(s) Proof | Blog</title> <meta name="generator" content="Jekyll v3.8.7" /> <meta property="og:title" content="Bellman Equation V(s) Proof" /> <meta name="author" content="Linfeng Chen" /> <meta property="og:locale" content="en" /> <meta name="description" content="An gentle way to show the key point in reinforcement learning" /> <meta property="og:description" content="An gentle way to show the key point in reinforcement learning" /> <link rel="canonical" href="http://find1dream.github.io/en/Bellman_Fuction_Proof" /> <meta property="og:url" content="http://find1dream.github.io/en/Bellman_Fuction_Proof" /> <meta property="og:site_name" content="Blog" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2019-07-08T00:00:00+09:00" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Linfeng Chen"},"headline":"Bellman Equation V(s) Proof","url":"http://find1dream.github.io/en/Bellman_Fuction_Proof","datePublished":"2019-07-08T00:00:00+09:00","description":"An gentle way to show the key point in reinforcement learning","dateModified":"2019-07-08T00:00:00+09:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://find1dream.github.io/en/Bellman_Fuction_Proof"},"@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> <meta name="msvalidate.01" content="9BA9FDD8EA34D27F827CC11CF3A2D49D" /> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" /> <!--[if lte IE 9]><meta http-equiv="refresh" content="0;url=/ie.html"><![endif]--> <meta name="author" content="Linfeng Chen"> <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,600|Droid+Sans+Mono' rel='stylesheet' type='text/css'> <link rel="shortcut icon" href="/assets/img/81icon.png" /> <link rel="stylesheet" href="/css/main.css"> <link rel="canonical" href="http://find1dream.github.io/en/Bellman_Fuction_Proof"> <link type="application/atom+xml" rel="alternate" href="http://find1dream.github.io/feed.xml" title="Blog" /> <script src="/assets/js/prefixfree.js"></script> <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script> <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> <link rel="stylesheet" href="/css/syntax.css"> <!-- <link rel="stylesheet" href="/assets/js/katex/katex.css"> <script src="/assets/js/katex/katex.js"></script> --> <link rel="stylesheet" href="/assets/js/katex/katex.css"> <meta content="Blog" property="og:site_name"> <meta content="article" property="og:type"> <meta content="An gentle way to show the key point in reinforcement learning" property="og:description"> <meta content="http://find1dream.github.io/en/Bellman_Fuction_Proof" property="og:url"> <meta content="2019-07-08T00:00:00+09:00" property="article:published_time"> <meta content="http://find1dream.github.io/about/" property="article:author"> <meta content="/img/logo-high-resolution.png" property="og:image"> <meta content="en" property="article:section"> <meta content="Reinforcement Learning" property="article:tag"> <meta content="Math" property="article:tag"> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-143337798-1', 'auto'); ga('send', 'pageview'); </script> </head> <!-- Begin Jekyll SEO tag v2.6.1 --> <title>It’s Really Easy To Play Flappy Bird Via Reinforcement Learning | Blog</title> <meta name="generator" content="Jekyll v3.8.7" /> <meta property="og:title" content="It’s Really Easy To Play Flappy Bird Via Reinforcement Learning" /> <meta name="author" content="Linfeng Chen" /> <meta property="og:locale" content="en" /> <meta name="description" content="This post shows how to play cart pole game with TD learning by pytorch." /> <meta property="og:description" content="This post shows how to play cart pole game with TD learning by pytorch." /> <link rel="canonical" href="http://find1dream.github.io/en/Flappy_Bird_DQN_with_Pytorch" /> <meta property="og:url" content="http://find1dream.github.io/en/Flappy_Bird_DQN_with_Pytorch" /> <meta property="og:site_name" content="Blog" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2019-08-15T00:00:00+09:00" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Linfeng Chen"},"headline":"It’s Really Easy To Play Flappy Bird Via Reinforcement Learning","url":"http://find1dream.github.io/en/Flappy_Bird_DQN_with_Pytorch","datePublished":"2019-08-15T00:00:00+09:00","description":"This post shows how to play cart pole game with TD learning by pytorch.","dateModified":"2019-08-15T00:00:00+09:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://find1dream.github.io/en/Flappy_Bird_DQN_with_Pytorch"},"@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> <body> <meta name="viewport" content="width=device-width, initial-scale=1"> <style> .dropbtn { background-color: #696969; color: rgba(255,255,255,0.7); padding: 12px; font-size: 16px; border: none; box-sizing: content-box; width: 100%; text-align: center; border-bottom:1px solid #fff; } .dropup { position: relative; display: inline-block; } .dropup-content { display: none; position: absolute; background-color: #f1f1f1; min-width: 120px; bottom: 40px; z-index: 1; } .dropup-content p { color: black; padding: 10px 0px; text-decoration: none; display: block; text-align: center; text-decoration: underline; } .dropup-content p:hover {background-color: #ccc;} .dropup:hover .dropup-content {display: block;} .dropup:hover .dropbtn {background-color: #ddd;} .mystyle { width: 100%; padding: 25px; background-color: coral; color: white; font-size: 25px; } </style> <style> .sidebar-tags { background-color: #696969; color: rgba(255,255,255,0.7); padding: 11px 45px 11px 44px; position: relative; top: 14px; font-size: 16px; border: none; box-sizing: content-box; width: 100%; text-align: center; text-decoration: none; border-bottom: 1px solid #fff; } .sidebar-archives { background-color: #696969; color: rgba(255,255,255,0.7); padding: 11px 29px 11px 29px; position: relative; top: 45px; font-size: 16px; border: none; box-sizing: content-box; width: 100%; text-align: center; text-decoration: none; border-bottom: 1px solid #fff; } } </style> <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script> <script>function initialization() { var elements_en = document.getElementsByClassName("sidebar-tag en"); var elements_ch = document.getElementsByClassName("sidebar-tag ch"); var elements_ja = document.getElementsByClassName("sidebar-tag ja"); for (var i = 0; i < elements_ch.length; i++){ elements_ch[i].style.display = 'block'; } for (var i = 0; i < elements_en.length; i++){ elements_en[i].style.display = 'none'; } for (var i = 0; i < elements_ja.length; i++){ elements_ja[i].style.display = 'none'; } } </script> <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script> <script>function myFunction_ch() { var elements_en = document.getElementsByClassName("sidebar-tag en"); var elements_ch = document.getElementsByClassName("sidebar-tag ch"); var elements_ja = document.getElementsByClassName("sidebar-tag ja"); for (var i = 0; i < elements_ch.length; i++){ elements_ch[i].style.display = 'block'; } for (var i = 0; i < elements_en.length; i++){ elements_en[i].style.display = 'none'; } for (var i = 0; i < elements_ja.length; i++){ elements_ja[i].style.display = 'none'; } }</script> <script>function myFunction_en() { var elements_en = document.getElementsByClassName("sidebar-tag en"); var elements_ch = document.getElementsByClassName("sidebar-tag ch"); var elements_ja = document.getElementsByClassName("sidebar-tag ja"); for (var i = 0; i < elements_ch.length; i++){ elements_ch[i].style.display = 'none'; } for (var i = 0; i < elements_en.length; i++){ elements_en[i].style.display = 'block'; } for (var i = 0; i < elements_ja.length; i++){ elements_ja[i].style.display = 'none'; } elements_en[0].style.display = 'none'; }</script> <script>function myFunction_ja() { var elements_en = document.getElementsByClassName("sidebar-tag en"); var elements_ch = document.getElementsByClassName("sidebar-tag ch"); var elements_ja = document.getElementsByClassName("sidebar-tag ja"); for (var i = 0; i < elements_ch.length; i++){ elements_ch[i].style.display = 'none'; } for (var i = 0; i < elements_en.length; i++){ elements_en[i].style.display = 'none'; } for (var i = 0; i < elements_ja.length; i++){ elements_ja[i].style.display = 'block'; } elements_ja[0].style.display = 'none'; }</script> <script>function reset(){ window.location.href.split("?")[0]; window.location.reload(); window.location.replace("/"); } </script> <script>function readMe_language(){ var avatar = document.getElementById("sidebar-avatar-img"); console.log(avatar); } </script> <aside id="sidebar" class="open"> <div id="sidebar-left"> <a id="sidebar-avatar" href="/"> <img id="sidebar-avatar-img" alt="" src="/assets/img/81icon.png"/> </a> <div id="sidebar-social"> <a href="/pages/feed.xml" class="sidebar-social-icon feed"></a> <a href="mailto:clinfeng.jlu@gmail.com" class="sidebar-social-icon email"></a> <!-- Generate icon by yourself https://icomoon.io/app/#/select --> <a href="https://github.com/find1dream" class="sidebar-social-icon github" target="_blank"></a> </div> <p></p> <ul id="sidebar-tags" class = "testa"> <div class="dropup"> <button class="dropbtn">Language</button> <div class="dropup-content"> <p onclick="myFunction_ch()">中文</p> <p onclick="myFunction_en()">English</p> <p onclick="myFunction_ja()">日本語</p> </div> </div> <li class="sidebar-tag active" data-filter="recent">Latest</li> <li class="sidebar-tag en" data-filter="en">en</li> <li class="sidebar-tag en" data-filter="Tech">Tech</li> <li class="sidebar-tag ch" data-filter="分享">分享</li> <li class="sidebar-tag ch" data-filter="读书">读书</li> <li class="sidebar-tag ja" data-filter="ja">ja</li> <li class="sidebar-tag ja" data-filter="読書">読書</li> <li class="sidebar-tag en" data-filter="Share">Share</li> <script>initialization();</script> <a class="sidebar-tags" href="/pages/tags.html">tags</a> <a class="sidebar-archives" href="/pages/archive.html">archives</a> </ul> </div> <div id="sidebar-right"> <div id="search-box"> <input id="search-input" type="text" placeholder="Search" /> </div> <nav id="toc"> <!-- <a onclick="window.location.href=this" class="toc-link ch" data-tags="分享" href="/ch/get_highly_skilled_foreign_professionals_visa_in_japan">DIY 申请高度专门职1号那些事</a> --> <a class="toc-link ch" data-tags="分享" href="/ch/get_highly_skilled_foreign_professionals_visa_in_japan">DIY 申请高度专门职1号那些事</a> <a class="toc-link en" data-tags="en Tech" href="/en/How_to_train_multiple_model_in_one_time_with_sklearn">How To Train Multiple Model In One Time With Sklearn</a> <a class="toc-link en" data-tags="en Tech" href="/en/Pandas_tricks">Pandas Tricks</a> <a class="toc-link en" data-tags="en Tech" href="/en/A_least_squares_approach">A Least Squares Approach</a> <a class="toc-link en" data-tags="en Tech" href="/en/Linear_modeling_Maximum_likelihood_approach">Linear Modeling - A Maximum Likelihood Approach</a> <a class="toc-link en" data-tags="en Tech" href="/en/Bayesian_approach_to_machine_learning">The Bayesian Approach To Machine Learning</a> <a class="toc-link en" data-tags="en Tech" href="/en/An_introduction_to_ESN">An Introduction To ESN</a> <a class="toc-link en" data-tags="en Tech" href="/en/Modeling_with_NMF_and_SVD">Modeling With NMF And SVD</a> <a class="toc-link en" data-tags="en Share" href="/en/Interesting_papers_to_replicate">Interesting Papers To Replicate</a> <a class="toc-link en" data-tags="en Share" href="/en/Feature_engineering">Feature Engineering For Machine Learning</a> <a class="toc-link en" data-tags="en Share" href="/en/C++_tricks">Usefull C++ Tricks</a> <a class="toc-link en" data-tags="en Tech" href="/en/PCA_and_SVD">PCA And SVD</a> <a class="toc-link en" data-tags="en Share" href="/en/How_to_change_CNN_structure_in_running_time_with_pytorch">An Easy Way To Change CNN Structure In Running Time With Pytorch</a> <a class="toc-link ja" data-tags="ja 読書" href="/ja/reviews-how_to_increase_your_money_in_an_easy_way">【Book Review】難しいことはわかりませんが、お金の増やし方を教えてください</a> <a class="toc-link en" data-tags="en Tech" href="/en/Bounding_box_introduction">Bounding Box Regression</a> <a class="toc-link ja" data-tags="ja 読書" href="/ja/reviews-boki_for_beginer_with_manga">【Book Review】オールカラー　マンガでわかる！はじめての簿記</a> <a class="toc-link en" data-tags="en Tech" href="/en/Flappy_Bird_DQN_with_Pytorch">It's Really Easy To Play Flappy Bird Via Reinforcement Learning</a> <!-- <a onclick="window.location.href=this" class="toc-link ch" data-tags="读书" href="/ch/reviews-attitude">【Book Review】态度</a> --> <a class="toc-link ch" data-tags="读书" href="/ch/reviews-attitude">【Book Review】态度</a> <!-- <a onclick="window.location.href=this" class="toc-link ch" data-tags="读书" href="/ch/reviews-complete_writing_guide">【Book Review】完全写作指南</a> --> <a class="toc-link ch" data-tags="读书" href="/ch/reviews-complete_writing_guide">【Book Review】完全写作指南</a> <a class="toc-link en" data-tags="en Tech" href="/en/Cart_Pole_example_for_Temporal_Difference_learning_with_Pytorch">How To Play Cart Pole Game with Temporal Difference Learning By Pytorch?</a> <!-- <a onclick="window.location.href=this" class="toc-link ch" data-tags="分享" href="/ch/how_to_improve_japanese_skills_from_N1">日语通过 N1 之后如何进阶？</a> --> <a class="toc-link ch" data-tags="分享" href="/ch/how_to_improve_japanese_skills_from_N1">日语通过 N1 之后如何进阶？</a> <a class="toc-link en" data-tags="en Tech" href="/en/An_introduction_to_Temporal-Difference_learning">An Easy Way To Understand Temporal-Difference Learning In Reinforcement Learning</a> <!-- <a onclick="window.location.href=this" class="toc-link ch" data-tags="读书" href="/ch/reviews-learn_how_to_write">【Book Review】学会写作：自我进阶的高效方法</a> --> <a class="toc-link ch" data-tags="读书" href="/ch/reviews-learn_how_to_write">【Book Review】学会写作：自我进阶的高效方法</a> <a class="toc-link en" data-tags="en Tech" href="/en/Importance_sampling_proof">Importance Sampling In Reinforcement learning</a> <!-- <a onclick="window.location.href=this" class="toc-link ch" data-tags="分享" href="/ch/how_to_make_practical_mindmaps_with_Marginnote-tool">如何用 Marginnote 做实用性强的思维导图（实践篇）</a> --> <a class="toc-link ch" data-tags="分享" href="/ch/how_to_make_practical_mindmaps_with_Marginnote-tool">如何用 Marginnote 做实用性强的思维导图（实践篇）</a> <!-- <a onclick="window.location.href=this" class="toc-link ch" data-tags="分享" href="/ch/how_to_make_practical_mindmaps_with_Marginnote-theory">如何用 Marginnote 做实用性强的思维导图（理论篇）</a> --> <a class="toc-link ch" data-tags="分享" href="/ch/how_to_make_practical_mindmaps_with_Marginnote-theory">如何用 Marginnote 做实用性强的思维导图（理论篇）</a> <a class="toc-link en" data-tags="en Tech" href="/en/An_introduction_to_Monte_Carlo_learning">An Easy Way To Understand Monte Carlo Learning In Reinforcement Learning</a> <a class="toc-link en" data-tags="en Tech" href="/en/An_introduction_to_dynamic_programming">An Easy Way To Understand Dynamic Programming In Reinforcement Learning</a> <a class="toc-link en" data-tags="en Tech" href="/en/An_introduction_to_mdp">An Easy Way To Understand Markov Decision Process In Reinforcement Learning</a> <!-- <a onclick="window.location.href=this" class="toc-link ch" data-tags="分享" href="/ch/why_do_I_choose_Jekyll_to_write_blog">为什么我选择 Jekyll + Github Pages 而不是 Wordpress 写技术博客？</a> --> <a class="toc-link ch" data-tags="分享" href="/ch/why_do_I_choose_Jekyll_to_write_blog">为什么我选择 Jekyll + Github Pages 而不是 Wordpress 写技术博客？</a> <a class="toc-link en" data-tags="en Tech" href="/en/The_Easiest_Introduction_To_Cross_Validation">The Easiest Introduction To Cross Validation</a> <a class="toc-link en" data-tags="en Tech" href="/en/How_To_Use_SVM_In_Python">How To Use SVM In Python?</a> <a class="toc-link en" data-tags="en Tech" href="/en/Bellman_Fuction_Proof">Bellman Equation V(s) Proof</a> </nav> </div> </aside> <main id="main" class="open"> <link rel="stylesheet" href="/css/en_font.css"> <article class="post container"> <div class="post-meta"> <span class="post-meta-span date">2019 August 15</span> <span class="post-meta-span tag">Reinforcement Learning, Application</span> <span id="busuanzi_container_page_pv" text-align="center"> <span id="busuanzi_value_page_pv"></span> </span> </div> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- horizontal_ads --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4428678099867228" data-ad-slot="2208981001" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <h1 class="post-title">It's Really Easy To Play Flappy Bird Via Reinforcement Learning</h1> <hr align="center" width="14%"> <p><img src="/assets/img/RL/DQN/flappy_bird_18_hours.gif" alt="stable" /> <em>Flappy Bird game played by reinforcement learning algorithm (DQN) after training 18 hours</em></p> <h2 id="introduction">Introduction</h2> <p>I think you must have heared about the famous game known as Flappy Bird. If not, please <a href="http://flappybird.io/">try it first</a>. It’s not easy to get high score. However, for a computer, it’s maybe very simlpe!</p> <p>In this post, I’ll show you how to play this game via reinforcement learning in only <strong>180 lines of code</strong>!. Since the algorithm is introduced in this post: <a href="https://find1dream.github.io/en/Cart_Pole_example_for_Temporal_Difference_learning_with_Pytorch">How To Play Cart Pole Game with Temporal Difference Learning By Pytorch?</a>, I’ll mainly introduce how to train the computer to play the game instead of math.</p> <p>The code is writen in python and the deep learning library is pytorch.</p> <h2 id="flappy-bird">Flappy Bird</h2> <p>We choose <a href="https://pygame-learning-environment.readthedocs.io/en/latest/user/games/flappybird.html">pygame learning environment</a> for game rendering environment. First you need to install it, please check <a href="https://pygame-learning-environment.readthedocs.io/en/latest/user/home.html">official site</a>.</p> <p>After installing the environment, you need to include the path to the PLE using</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">"/path/to/PyGame-Learning-Environment"</span><span class="p">)</span>
</code></pre></div></div> <p>For example, if you use the code below, you can see the flapy bird!</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">"/path/to/PyGame-Learning-Environment"</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">ple.games.flappybird</span> <span class="kn">import</span> <span class="n">FlappyBird</span>
<span class="kn">from</span> <span class="nn">ple</span> <span class="kn">import</span> <span class="n">PLE</span>

<span class="n">game</span> <span class="o">=</span> <span class="n">FlappyBird</span><span class="p">()</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">PLE</span><span class="p">(</span><span class="n">game</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">display_screen</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">force_fps</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">init</span><span class="p">()</span>
<span class="n">actions</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">getActionSet</span><span class="p">()</span>
<span class="n">action_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">actions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">:</span><span class="n">actions</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>

<span class="n">reward</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
   <span class="k">if</span> <span class="n">p</span><span class="p">.</span><span class="n">game_over</span><span class="p">():</span>
           <span class="n">p</span><span class="p">.</span><span class="n">reset_game</span><span class="p">()</span>

   <span class="n">state</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">getScreenRGB</span><span class="p">()</span>
   <span class="n">action</span> <span class="o">=</span> <span class="mi">1</span>
   <span class="n">reward</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">act</span><span class="p">(</span><span class="n">action_dict</span><span class="p">[</span><span class="n">action</span><span class="p">])</span>
</code></pre></div></div> <p>The state in this game can be RGB image returned by <code class="highlighter-rouge">getScreenRGB()</code> or non-visual state representation of the game returned by <code class="highlighter-rouge">getGameState()</code>. In this post, I will show you how to use convolutional neural networks to train the computer, thus we choose <code class="highlighter-rouge">getScreenRGB()</code>. The returned image size is (512, 288, 3), since the ground is useless we will remove them, and resize the image to 80x80, then binarize it for faster convergence. Here is the image preprecess function.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">img_preprocess</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">ROTATE_90_CLOCKWISE</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">flip</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>

    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:</span><span class="mi">400</span><span class="p">,:]</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">retval</span><span class="p">,</span> <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">THRESH_BINARY</span><span class="p">)</span>
    <span class="c1">#img = torch.FloatTensor(img)
</span>    <span class="k">return</span> <span class="n">img</span>
</code></pre></div></div> <p>With the image preprocessed, the image becomes:</p> <p><img src="/assets/img/RL/DQN/flappy_bird_binarization.png" alt="stable" /> <em>Image preprocess</em></p> <h2 id="dqn">DQN</h2> <p>It’s a very simple convolutional neural networks writen in pytorch.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DQN</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_space</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DQN</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span> <span class="n">nn</span><span class="p">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">nn</span><span class="p">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="p">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">*</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span> <span class="n">nn</span><span class="p">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">action_space</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">observation</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">.</span><span class="n">view</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>
</code></pre></div></div> <p>Here is the algorithm from nature paper. The training code is respongding with the algorithm, please make sure to read the code and algorithm carefully. <img src="/assets/img/RL/DQN/DQN_algorithm.png" alt="" /> <em>Deep Q-learning with experience replay</em></p> <h2 id="show-me-the-code">Show me the code</h2> <p>Here is th full script.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">"/path/to/PyGame-Learning-Environment"</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">ple.games.flappybird</span> <span class="kn">import</span> <span class="n">FlappyBird</span>
<span class="kn">from</span> <span class="nn">ple</span> <span class="kn">import</span> <span class="n">PLE</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="n">optim</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">from</span> <span class="nn">torch.utils.tensorboard</span> <span class="kn">import</span> <span class="n">SummaryWriter</span>

<span class="n">GAMMA</span> <span class="o">=</span> <span class="mf">0.99</span>
<span class="n">LEARNING_RATE</span> <span class="o">=</span> <span class="mf">3e-6</span>
<span class="n">MEMORY_SIZE</span> <span class="o">=</span> <span class="mi">50000</span>
<span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">48</span>
<span class="n">EXPLORATION_MAX</span> <span class="o">=</span> <span class="mf">5e-2</span>
<span class="n">EXPLORATION_MIN</span> <span class="o">=</span> <span class="mf">1e-5</span>
<span class="n">EXPLORATION_DECAY</span> <span class="o">=</span> <span class="mf">0.9999</span>

<span class="n">Model_path</span> <span class="o">=</span> <span class="s">"./model.pth"</span>
<span class="n">writer</span> <span class="o">=</span> <span class="n">SummaryWriter</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">DQN</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_space</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DQN</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span> <span class="n">nn</span><span class="p">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">nn</span><span class="p">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">nn</span><span class="p">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fc1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">6</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">*</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span> <span class="n">nn</span><span class="p">.</span><span class="n">ReLU</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fc2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">action_space</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">observation</span><span class="p">):</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">observation</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">.</span><span class="n">view</span><span class="p">(</span><span class="n">output</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">fc1</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">fc2</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>
<span class="k">class</span> <span class="nc">GameSolver</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_space</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">exploration_rate</span> <span class="o">=</span> <span class="n">EXPLORATION_MAX</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">action_space</span> <span class="o">=</span> <span class="n">action_space</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">memory</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">MEMORY_SIZE</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">Q_policy</span> <span class="o">=</span> <span class="n">DQN</span><span class="p">(</span><span class="n">action_space</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">Q_target</span> <span class="o">=</span> <span class="n">copy</span><span class="p">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">Q_policy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">():</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">Q_policy</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">Q_policy</span><span class="p">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">Q_target</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">Q_target</span><span class="p">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">Q_policy</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span> <span class="o">=</span> <span class="n">LEARNING_RATE</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">lossFuc</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">MSELoss</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">remember</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">done</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">memory</span><span class="p">.</span><span class="n">append</span><span class="p">((</span><span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">next_state</span><span class="p">,</span> <span class="n">done</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>

        <span class="n">q_values</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">Q_policy</span><span class="p">(</span><span class="n">state</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># best action
</span>        <span class="k">if</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">exploration_rate</span><span class="p">:</span>
            <span class="n">max_q_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="p">.</span><span class="n">randrange</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">action_space</span><span class="p">)]</span>
            <span class="n">max_q_one_hot</span> <span class="o">=</span>  <span class="n">one_hot_embedding</span><span class="p">(</span><span class="n">max_q_index</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">action_space</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">max_q_index</span> <span class="o">=</span>  <span class="p">[</span><span class="n">torch</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">q_values</span><span class="p">,</span> <span class="mi">0</span><span class="p">).</span><span class="n">indices</span><span class="p">.</span><span class="n">cpu</span><span class="p">().</span><span class="n">numpy</span><span class="p">().</span><span class="n">tolist</span><span class="p">()]</span>
            <span class="n">max_q_one_hot</span> <span class="o">=</span>  <span class="n">one_hot_embedding</span><span class="p">(</span><span class="n">max_q_index</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">action_space</span><span class="p">)</span>
       <span class="c1"># print(torch.max(q_values).detach().numpy())
</span>        <span class="k">return</span> <span class="n">max_q_index</span><span class="p">,</span> <span class="n">max_q_one_hot</span><span class="p">,</span> <span class="n">q_values</span>

    <span class="k">def</span> <span class="nf">experince_replay</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">memory</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">BATCH_SIZE</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="n">random</span><span class="p">.</span><span class="n">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">memory</span><span class="p">,</span> <span class="n">BATCH_SIZE</span><span class="p">)</span>
        <span class="n">state_batch</span><span class="p">,</span> <span class="n">action_batch</span><span class="p">,</span> <span class="n">reward_batch</span><span class="p">,</span> <span class="n">next_state_batch</span><span class="p">,</span> <span class="n">terminal_batch</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">state_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">cat</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">state</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">state_batch</span><span class="p">))</span>
        <span class="n">action_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">cat</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">action</span> <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">action_batch</span><span class="p">))</span>
        <span class="n">reward_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">cat</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">reward</span> <span class="k">for</span> <span class="n">reward</span> <span class="ow">in</span> <span class="n">reward_batch</span><span class="p">))</span>
        <span class="n">reward_batch</span> <span class="o">=</span> <span class="n">reward_batch</span><span class="p">.</span><span class="n">view</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">reward_batch</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">next_state_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">cat</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">next_state</span> <span class="k">for</span> <span class="n">next_state</span> <span class="ow">in</span> <span class="n">next_state_batch</span><span class="p">))</span>
        <span class="n">current_prediction_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">Q_policy</span><span class="p">(</span><span class="n">state_batch</span><span class="p">)</span>
        <span class="n">next_prediction_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">Q_target</span><span class="p">(</span><span class="n">next_state_batch</span><span class="p">)</span>

        <span class="n">y_batch</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">cat</span><span class="p">(</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="n">reward</span> <span class="k">if</span> <span class="n">terminal</span> <span class="k">else</span> <span class="n">reward</span> <span class="o">+</span> <span class="n">GAMMA</span> <span class="o">*</span> <span class="n">torch</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span> <span class="k">for</span> <span class="n">reward</span><span class="p">,</span> <span class="n">terminal</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span>
                  <span class="nb">zip</span><span class="p">(</span><span class="n">reward_batch</span><span class="p">,</span> <span class="n">terminal_batch</span><span class="p">,</span> <span class="n">next_prediction_batch</span><span class="p">)))</span>

        <span class="n">q_value</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">current_prediction_batch</span> <span class="o">*</span> <span class="n">action_batch</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="c1"># y_batch = y_batch.detach()
</span>        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">lossFuc</span><span class="p">(</span><span class="n">q_value</span><span class="p">,</span> <span class="n">y_batch</span><span class="p">)</span>
        <span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">exploration_rate</span> <span class="o">*=</span> <span class="n">EXPLORATION_DECAY</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">exploration_rate</span>  <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">EXPLORATION_MIN</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">exploration_rate</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Flappy_bird</span><span class="p">():</span>
    <span class="n">game</span> <span class="o">=</span> <span class="n">FlappyBird</span><span class="p">()</span>
    <span class="n">game</span><span class="p">.</span><span class="n">allowed_fps</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">PLE</span><span class="p">(</span><span class="n">game</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">display_screen</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">force_fps</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">init</span><span class="p">()</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">getActionSet</span><span class="p">()</span>
    <span class="n">action_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="n">actions</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">:</span><span class="n">actions</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
    <span class="n">reward</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">gameSolver</span> <span class="o">=</span> <span class="n">GameSolver</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">actions</span><span class="p">))</span>
    <span class="n">run</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">run</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">p</span><span class="p">.</span><span class="n">reset_game</span><span class="p">()</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">img_preprocess</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">getScreenRGB</span><span class="p">())</span>
        <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">run</span> <span class="o">%</span> <span class="mi">5000</span> <span class="o">==</span> <span class="mi">4999</span><span class="p">:</span>
            <span class="n">torch</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">gameSolver</span><span class="p">.</span><span class="n">Q_policy</span><span class="p">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">Model_path</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">step</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">action</span><span class="p">,</span> <span class="n">action_one_hot</span><span class="p">,</span> <span class="n">p_values</span> <span class="o">=</span> <span class="n">gameSolver</span><span class="p">.</span><span class="n">predict</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="n">reward</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">act</span><span class="p">(</span><span class="n">action_dict</span><span class="p">[</span><span class="n">action</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">state_next</span> <span class="o">=</span> <span class="n">img_preprocess</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">getScreenRGB</span><span class="p">())</span>
            <span class="n">terminal</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">game_over</span><span class="p">()</span>

            <span class="n">reward</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">reward</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">():</span>
                <span class="n">reward</span> <span class="o">=</span> <span class="n">reward</span><span class="p">.</span><span class="n">cuda</span><span class="p">()</span>
                <span class="n">action_one_hot</span> <span class="o">=</span> <span class="n">action_one_hot</span><span class="p">.</span><span class="n">cuda</span><span class="p">()</span>
            <span class="n">gameSolver</span><span class="p">.</span><span class="n">remember</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">action_one_hot</span><span class="p">,</span> <span class="n">reward</span><span class="p">,</span> <span class="n">state_next</span><span class="p">,</span>
                                <span class="n">terminal</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">state_next</span>

            <span class="k">if</span> <span class="n">terminal</span><span class="p">:</span>
                <span class="k">print</span> <span class="p">(</span><span class="s">"Run: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">run</span><span class="p">)</span> <span class="o">+</span> <span class="s">", exploration: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gameSolver</span><span class="p">.</span><span class="n">exploration_rate</span><span class="p">)</span> <span class="o">+</span> <span class="s">", score: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">step</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">writer</span><span class="p">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s">'Q_value'</span><span class="p">,</span> <span class="n">torch</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="n">p_values</span><span class="p">),</span> <span class="n">run</span><span class="p">)</span>
                <span class="n">writer</span><span class="p">.</span><span class="n">add_scalar</span><span class="p">(</span><span class="s">'Score'</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">run</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="n">gameSolver</span><span class="p">.</span><span class="n">experince_replay</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="mi">50</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">gameSolver</span><span class="p">.</span><span class="n">Q_target</span><span class="p">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">copy</span><span class="p">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">gameSolver</span><span class="p">.</span><span class="n">Q_policy</span><span class="p">.</span><span class="n">state_dict</span><span class="p">()))</span>
<span class="k">def</span> <span class="nf">one_hot_embedding</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">):</span>
    <span class="s">"""Embedding labels to one-hot form.
    Args:
      labels: (LongTensor) class labels, sized [N,].
      num_classes: (int) number of classes.

    Returns:
      (tensor) encoded labels, sized [N, #classes].
    """</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">eye</span><span class="p">(</span><span class="n">num_classes</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">y</span><span class="p">[</span><span class="n">labels</span><span class="p">]</span> 

<span class="k">def</span> <span class="nf">img_preprocess</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">ROTATE_90_CLOCKWISE</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">flip</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2RGB</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">[:</span><span class="mi">400</span><span class="p">,:]</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
    <span class="n">retval</span><span class="p">,</span> <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">threshold</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">THRESH_BINARY</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">():</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">img</span><span class="p">.</span><span class="n">cuda</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">img</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">Flappy_bird</span><span class="p">()</span>
</code></pre></div></div> <p>Here is the result after training 18 hours: <img src="/assets/img/RL/DQN/flappy_bird_q_score.png" alt="" /> <em>Deep Q-learning with experience replay</em></p> <h2 id="summary">Summary</h2> <p>In this post we introduced how to use neural networks to play Flappy Bird game in only 180 lines of code. However, as you can see, the system need a lot of time to learn even for such an easy game! Also, the DQN is not very stable since it will also make many mistakes. In the following posts, we will introduce other methods to improve DQN, and policy gradient methods that can be better than simple DQN.</p> <h2 id="references">References</h2> <ul> <li><a href="https://hardikbansal.github.io/FlappyDQNBlog/">Is it that hard? Playing Flappy Bird via Reinforcement Learning</a></li> <li><a href="https://pytorch.org/tutorials/intermediate/reinforcement_q_learning.html">REINFORCEMENT LEARNING (DQN) TUTORIAL</a></li> <li><a href="https://www.youtube.com/watch?v=_4JaUUcsnvc">Deep Q-Network (DQN) video</a></li> <li><a href="https://medium.com/@jonathan_hui/rl-dqn-deep-q-network-e207751f7ae4">RL — DQN Deep Q-network</a></li> </ul> <hr align="center" width="14%"> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <!-- horizontal_ads --> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4428678099867228" data-ad-slot="2208981001" data-ad-format="auto" data-full-width-responsive="true"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script> <div class="relatedPosts"> <h4 id="related_posts">You May Also Enjoy</h4> <script > $("#related_posts").hide(); </script> <script > $("#related_posts").show(); </script> <div> <h5><a href="/en/Cart_Pole_example_for_Temporal_Difference_learning_with_Pytorch">How To Play Cart Pole Game with Temporal Difference Learning By Pytorch? <span class="label label-default">--Reinforcement Learning</span> <span class="label label-default">--Application</span> </a></h5> </div> <script > $("#related_posts").show(); </script> <div> <h5><a href="/en/An_introduction_to_Temporal-Difference_learning">An Easy Way To Understand Temporal-Difference Learning In Reinforcement Learning <span class="label label-default">--Reinforcement Learning</span> </a></h5> </div> <script > $("#related_posts").show(); </script> <div> <h5><a href="/en/Importance_sampling_proof">Importance Sampling In Reinforcement learning <span class="label label-default">--Reinforcement Learning</span> </a></h5> </div> <script > $("#related_posts").show(); </script> <div> <h5><a href="/en/An_introduction_to_Monte_Carlo_learning">An Easy Way To Understand Monte Carlo Learning In Reinforcement Learning <span class="label label-default">--Reinforcement Learning</span> </a></h5> </div> <script > $("#related_posts").show(); </script> <div> <h5><a href="/en/An_introduction_to_dynamic_programming">An Easy Way To Understand Dynamic Programming In Reinforcement Learning <span class="label label-default">--Reinforcement Learning</span> </a></h5> </div> <script > $("#related_posts").show(); </script> <div> <h5><a href="/en/An_introduction_to_mdp">An Easy Way To Understand Markov Decision Process In Reinforcement Learning <span class="label label-default">--Reinforcement Learning</span> </a></h5> </div> </div> <p><strong>Welcome to share or comment on this post: </strong></p> </article> <div class="post-share"> <div class="container"> <!-- AddToAny BEGIN --> <div class="a2a_kit a2a_kit_size_32 a2a_default_style" style=" float: unset; display: inline-flex; place-items: center;"> <a class="a2a_dd" href="https://www.addtoany.com/share"></a> <a class="a2a_button_wechat"></a> <a class="a2a_button_evernote"></a> <a class="a2a_button_line"></a> <a class="a2a_button_sina_weibo"></a> <a class="a2a_button_douban"></a> <a class="a2a_button_qzone"></a> </div> <script> var a2a_config = a2a_config || {}; a2a_config.onclick = 1; </script> <script async src="https://static.addtoany.com/menu/page.js"></script> <!-- AddToAny END --> </div> </div> <div class="comment container"> <div id="disqus_thread"> </div> </div> <div class="footer"> <div class="container"> <p class="footer-entry">All content is licensed under <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA</a></p> <p class="footer-entry">Built with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> and <a href="https://github.com/P233/3-Jekyll" target="_blank">3-Jekyll theme</a> • Hosted on <a href="https://pages.github.com/" target="_blank">Github</a></p> </div> </div> </main> <button id="menu" class="open"> <span id="menu-icons"></span> </button> <button id="post-toc-menu"> <span id="post-toc-menu-icons"></span> </button> <div id="post-toc"> <span id="post-toc-title">Table of Contents</span> <ul id="post-toc-ul"></ul> </div> <script src="/assets/js/jquery-2.1.3.min.js"></script> <script src="/assets/js/jquery.pjax.js"></script> <script src="/assets/js/nprogress.js"></script> <script src="/assets/js/main.js"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-143337798-1', 'auto'); ga('send', 'pageview'); </script> <!-- Load jQuery --> <!-- Load KaTeX --> </body> </html>
